<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tìm Kiếm & Thay Thế Chương</title>
    <link rel="icon" href="data:,">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
    <style>
        .hl-yellow { background: #ffff99; color: black; }
        .hl-pink   { background: #ffcccc; color: black; }
        .hl-blue   { background: #99ccff; color: black; }
        .hl-green  { background: #ccffcc; color: black; }
        .hl-orange { background: #ffcc99; color: black; }
        .hl-purple { background: #e6ccff; color: black; }
        [contenteditable]:empty:before { content: attr(placeholder); color: #aaa; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <!-- Auth Form -->
    <div id="auth-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Đăng Nhập / Đăng Ký</h2>
            <form id="auth-form" class="space-y-4">
                <input type="email" id="auth-email" placeholder="Email" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="auth-password" placeholder="Mật khẩu (≥6 ký tự)" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex gap-2">
                    <button type="submit" id="login-btn" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                        Đăng Nhập
                    </button>
                    <button type="button" id="signup-btn" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">
                        Đăng Ký
                    </button>
                </div>
                <div id="auth-error" class="text-red-600 text-sm text-center min-h-6"></div>
            </form>
        </div>
    </div>

    <!-- GIAO DIỆN CHÍNH -->
    <div id="app-container" class="hidden flex flex-col h-screen">
        <!-- NÚT ĐĂNG XUẤT -->
        <div class="p-2 bg-gray-800 text-white text-right">
            <button id="logout-btn" class="px-3 py-1 bg-red-600 rounded text-xs hover:bg-red-700">Đăng xuất</button>
        </div>
        <div class="flex flex-1 overflow-hidden">
            <!-- Left Panel -->
            <div id="main-panel" class="w-1/5 p-4 bg-white shadow-md overflow-y-auto text-sm">
                <h2 class="text-xl font-bold mb-4">Tìm Kiếm</h2>

                <!-- FONT + CỠ CHỮ 1 HÀNG -->
                <div class="mb-4">
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="block mb-1 text-xs">Font:</label>
                            <select id="fontFamily" class="w-full p-1.5 border rounded text-xs">
                                <option value="Arial">Arial</option>
                                <option value="Calibri">Calibri</option>
                                <option value="Montserrat">Montserrat</option>
                                <option value="Times New Roman">Times New Roman</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block mb-1 text-xs">Cỡ chữ:</label>
                            <select id="fontSize" class="w-full p-1.5 border rounded text-xs">
                                <option value="14px">14px</option>
                                <option value="16px">16px</option>
                                <option value="18px">18px</option>
                                <option value="20px">20px</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- CHECKBOX -->
                <div class="mb-4">
                    <label class="block mb-1 text-xs"><input type="checkbox" id="matchCase" class="mr-1 align-middle"> Phân biệt hoa/thường</label>
                    <label class="block mb-1 text-xs"><input type="checkbox" id="wholeWords" class="mr-1 align-middle"> Từ hoàn chỉnh</label>
                </div>

                <!-- CHẾ ĐỘ TỪ KHÓA: 3 NÚT TRÊN 1 HÀNG -->
                <div class="mb-4">
                    <label class="block mb-1 text-xs">Chế độ từ khóa:</label>
                    <div class="flex gap-1 items-center">
                        <select id="keyword-mode-select" class="flex-1 p-1.5 border rounded text-xs"></select>
                        <button id="add-keyword-mode" class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">+</button>
                        <button id="delete-keyword-mode" class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">−</button>
                        <button id="save-keywords-btn" class="px-2 py-1 bg-indigo-600 text-white rounded text-xs hover:bg-indigo-700">Lưu</button>
                    </div>
                </div>

                <!-- TỪ KHÓA -->
                <div class="mb-4">
                    <label class="block mb-1 text-xs">Từ khóa:</label>
                    <input type="text" id="keywords-input" placeholder="Nhập, Enter..." class="w-full p-1.5 border rounded bg-gray-50 text-xs">
                </div>

                <!-- NÚT TÌM / XÓA -->
                <div class="flex gap-2 mb-4">
                    <button id="search" class="flex-1 bg-green-500 text-white py-2 rounded hover:bg-green-600 text-xs font-medium">Tìm Kiếm</button>
                    <button id="clear" class="flex-1 bg-red-500 text-white py-2 rounded hover:bg-red-600 text-xs font-medium">Xóa Tất Cả</button>
                </div>

                <!-- TAGS -->
                <div id="keywords-tags" class="flex flex-wrap gap-1 mb-4"></div>
            </div>

            <!-- Center: FULL HEIGHT -->
            <div id="text-panel" class="flex-1 p-6 bg-white shadow-md mx-4 flex flex-col">
                <div class="flex justify-between items-start mb-2">
                    <h2 class="text-xl font-bold">Nội Dung Chương</h2>
                    <div class="text-right text-xs text-red-600 font-semibold leading-tight">
                        <div>Don@te cho ad: MB BANK - TRINH THI XUAN HUONG - STK: 0917678211</div>
                        <div>Góp ý: <a href="https://www.facebook.com/trinh.hg.57" target="_blank" class="text-blue-600 underline hover:text-blue-800">https://www.facebook.com/trinh.hg.57</a></div>
                    </div>
                </div>
                <div id="textInput"
                     contenteditable="true"
                     placeholder="Dán văn bản vào đây..."
                     class="flex-1 p-6 border-2 border-gray-300 rounded-lg focus:outline-none whitespace-pre-wrap overflow-y-auto"
                     style="font-family: Arial; font-size: 16px; line-height: 1.8; min-height: 0;">
                </div>
            </div>

            <!-- Right Panel -->
            <div id="settings-panel" class="w-1/5 p-4 bg-white shadow-md overflow-y-auto text-xs">
                <h2 class="text-xl font-bold mb-4">Thay Thế</h2>
                <div class="mode-controls mb-3 space-y-1">
                    <div class="flex gap-1">
                        <select id="mode-select" class="flex-1 p-1 border rounded text-xs"></select>
                        <button id="add-mode" class="px-1 py-0.5 bg-blue-500 text-white rounded text-xs">Thêm</button>
                    </div>
                    <!-- 3 NÚT CÙNG 1 HÀNG: SAO | XÓA | CASE -->
                    <div class="flex gap-1">
                        <button id="copy-mode" class="flex-1 px-1 py-0.5 bg-blue-500 text-white rounded text-xs">Sao</button>
                        <button id="delete-mode" class="flex-1 px-1 py-0.5 bg-red-500 text-white rounded text-xs">Xóa</button>
                        <button id="match-case" class="flex-1 px-1 py-0.5 bg-gray-500 text-white rounded text-xs">Case</button>
                    </div>
                    <div class="flex gap-1">
                        <button id="export-settings" class="flex-1 px-1 py-0.5 bg-blue-500 text-white rounded text-xs">Xuất</button>
                        <button id="import-settings" class="flex-1 px-1 py-0.5 bg-blue-500 text-white rounded text-xs">Nhập</button>
                    </div>
                </div>

                <div class="action-buttons mb-3 flex gap-1">
                    <button id="add-pair" class="flex-1 px-2 py-1 bg-blue-500 text-white rounded text-xs">Cặp</button>
                    <button id="save-settings" class="flex-1 px-2 py-1 bg-green-600 text-white rounded text-xs">Lưu</button>
                    <button id="replace-all" class="flex-1 px-2 py-1 bg-purple-600 text-white rounded text-xs">Thay</button>
                </div>

                <div id="punctuation-list" class="space-y-2 text-xs"></div>
            </div>
        </div>
    </div>

    <div id="notification-container"></div>

    <!-- Nhost SDK + FIX ĐĂNG NHẬP (F5 TỰ ĐỘNG) -->
    <script type="module">
        import { NhostClient } from 'https://esm.sh/@nhost/nhost-js@3.3.1';

        const nhost = new NhostClient({
            subdomain: "ogltettlkspwxyqphmth",
            region: "eu-central-1"
        });

        const authOverlay = document.getElementById('auth-overlay');
        const appContainer = document.getElementById('app-container');
        const authError = document.getElementById('auth-error');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const emailInput = document.getElementById('auth-email');
        const passwordInput = document.getElementById('auth-password');

        const validateEmail = e => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.trim());
        const validatePassword = p => p && p.length >= 6;

        const showApp = () => {
            authOverlay.classList.add('hidden');
            appContainer.classList.remove('hidden');
            console.log('Màn hình chính đã hiện');
        };

        const checkSession = async () => {
            try {
                const user = await nhost.auth.getUser();
                if (user) {
                    console.log('Đã đăng nhập (F5):', user.email);
                    showApp();
                }
            } catch (err) {
                console.error('Lỗi session:', err);
            }
        };

        // GỌI NGAY + LẮNG NGHE
        checkSession();
        nhost.auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Auth thay đổi → Đã đăng nhập');
                showApp();
            }
        });

        loginBtn.onclick = async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            if (!validateEmail(email)) return authError.textContent = 'Email không hợp lệ';
            if (!validatePassword(password)) return authError.textContent = 'Mật khẩu ≥6 ký tự';

            authError.textContent = 'Đang đăng nhập...';
            try {
                const { error } = await nhost.auth.signIn({ email, password });
                if (error?.message.includes('already signed in')) {
                    setTimeout(showApp, 300);
                    return;
                }
                if (error) throw error;
                setTimeout(showApp, 300);
            } catch (err) {
                authError.textContent = err.message || 'Lỗi đăng nhập';
            }
        };

        signupBtn.onclick = async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            if (!validateEmail(email)) return authError.textContent = 'Email không hợp lệ';
            if (!validatePassword(password)) return authError.textContent = 'Mật khẩu ≥6 ký tự';

            authError.textContent = 'Đang đăng ký...';
            try {
                const { error } = await nhost.auth.signUp({ email, password });
                if (error) throw error;
                authError.textContent = 'Đăng ký thành công! Đăng nhập ngay.';
                authError.style.color = 'green';
            } catch (err) {
                authError.textContent = err.message || 'Lỗi đăng ký';
            }
        };

        logoutBtn.onclick = async () => {
            await nhost.auth.signOut();
            authOverlay.classList.remove('hidden');
            appContainer.classList.add('hidden');
        };

        window.nhost = nhost;
    </script>

    <!-- JS CHÍNH -->
    <script src="index.js"></script>
</body>
</html>
