<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tìm Kiếm & Thay Thế Chương</title>
  <style>
    :root{--primary:#007bff;--danger:#dc3545;--light:#f8f9fa;--border:#dee2e6}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Segoe UI,Tahoma,sans-serif;background:var(--light);color:#333;line-height:1.6;padding:20px}
    #auth-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1000}
    .auth-box{background:#fff;padding:30px;border-radius:12px;width:90%;max-width:400px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .auth-box h2{margin-bottom:20px}
    input,button{width:100%;padding:12px;margin:8px 0;border:1px solid var(--border);border-radius:8px;font-size:16px}
    input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(0,123,255,.25)}
    button{background:var(--primary);color:#fff;font-weight:bold;cursor:pointer;transition:.2s}
    button:hover{background:#0056b3}
    button:disabled{background:#6c757d;cursor:not-allowed}
    #auth-error{color:var(--danger);min-height:24px;margin-top:10px;font-size:14px}
    #main-panel{max-width:900px;margin:40px auto;padding:30px;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.1)}
    .hidden{display:none!important}
  </style>
</head>
<body>

  <!-- Auth Overlay -->
  <div id="auth-overlay">
    <div class="auth-box">
      <h2>Đăng Nhập / Đăng Ký</h2>
      <input type="email" id="auth-email" placeholder="Email">
      <input type="password" id="auth-password" placeholder="Mật khẩu (≥6 ký tự)">
      <button id="login-btn">Đăng Nhập</button>
      <button id="signup-btn">Đăng Ký</button>
      <div id="auth-error"></div>
    </div>
  </div>

  <!-- Main Panel -->
  <div id="main-panel" class="hidden">
    <h1>Tìm Kiếm & Thay Thế Chương</h1>
    <p>Chào mừng! Bạn đã đăng nhập thành công.</p>
    <!-- Nội dung chính của bạn sẽ nằm ở đây -->
  </div>

  <script type="module">
    document.addEventListener('DOMContentLoaded', async () => {
      // ---------- Nhost SDK ----------
      const { NhostClient } = await import('https://esm.sh/@nhost/nhost-js@3.3.1');
      const nhost = new NhostClient({
        subdomain: 'ogltettlkspwxyqphmth',
        region: 'eu-central-1'
      });

      // ---------- DOM ----------
      const authOverlay = document.getElementById('auth-overlay');
      const mainPanel   = document.getElementById('main-panel');
      const authError   = document.getElementById('auth-error');
      const loginBtn    = document.getElementById('login-btn');
      const signupBtn   = document.getElementById('signup-btn');
      const emailInput  = document.getElementById('auth-email');
      const pwInput     = document.getElementById('auth-password');

      // ---------- Helper ----------
      const validateEmail = e => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.trim());
      const validatePw    = p => p && p.length >= 6;
      const resetBtn = (b,t) => { b.disabled = false; b.textContent = t; };
      const showMain = () => { authOverlay.classList.add('hidden'); mainPanel.classList.remove('hidden'); };
      const hideMain = () => { authOverlay.classList.remove('hidden'); mainPanel.classList.add('hidden'); };

      // ---------- Kiểm tra session ngay khi load ----------
      const checkSession = async () => {
        const { session } = await nhost.auth.getSession();   // không reject, luôn trả về session hoặc null
        if (session) {
          console.log('Đã có session → tự động vào app', session);
          showMain();
        } else {
          hideMain();
        }
      };
      await checkSession();

      // ---------- Auth state listener (đồng bộ realtime) ----------
      nhost.auth.onAuthStateChanged(async (event, session) => {
        console.log('Auth state:', event, session?.user?.email);
        if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') showMain();
        else hideMain();
      });

      // ---------- ĐĂNG NHẬP ----------
      loginBtn.onclick = async () => {
        authError.textContent = '';
        loginBtn.disabled = true;
        loginBtn.textContent = 'Đang đăng nhập...';

        const email = emailInput.value.trim();
        const pw    = pwInput.value;

        if (!email || !pw) { authError.textContent='Nhập email & mật khẩu'; resetBtn(loginBtn,'Đăng Nhập'); return; }
        if (!validateEmail(email)) { authError.textContent='Email không hợp lệ'; resetBtn(loginBtn,'Đăng Nhập'); return; }
        if (!validatePw(pw)) { authError.textContent='Mật khẩu ≥6 ký tự'; resetBtn(loginBtn,'Đăng Nhập'); return; }

        try {
          const { error } = await nhost.auth.signIn({ email, password: pw });
          if (error) {
            // Lỗi 20 = already‑signed‑in → không cần báo lỗi, chỉ refresh UI
            if (error.status === 20 && error.error === 'already-signed-in') {
              console.warn('User already signed in → UI sẽ tự cập nhật');
              return;
            }
            throw error;
          }
        } catch (e) {
          authError.textContent = e.message || 'Đăng nhập thất bại';
          console.error('Lỗi đăng nhập:', e);
        } finally {
          resetBtn(loginBtn,'Đăng Nhập');
        }
      };

      // ---------- ĐĂNG KÝ ----------
      signupBtn.onclick = async () => {
        authError.textContent = '';
        signupBtn.disabled = true;
        signupBtn.textContent = 'Đang đăng ký...';

        const email = emailInput.value.trim();
        const pw    = pwInput.value;

        if (!email || !pw) { authError.textContent='Nhập email & mật khẩu'; resetBtn(signupBtn,'Đăng Ký'); return; }
        if (!validateEmail(email)) { authError.textContent='Email không hợp lệ'; resetBtn(signupBtn,'Đăng Ký'); return; }
        if (!validatePw(pw)) { authError.textContent='Mật khẩu ≥6 ký tự'; resetBtn(signupBtn,'Đăng Ký'); return; }

        try {
          const { error } = await nhost.auth.signUp({ email, password: pw });
          if (error) {
            if (error.status === 20 && error.error === 'already-signed-in') {
              authError.textContent = 'Bạn đã đăng nhập rồi. F5 để vào app.';
              authError.style.color = 'orange';
              return;
            }
            throw error;
          }
          authError.textContent = 'Đăng ký OK! Kiểm tra email (nếu bật verify) rồi đăng nhập.';
          authError.style.color = 'green';
        } catch (e) {
          authError.textContent = e.message || 'Đăng ký thất bại';
          console.error('Lỗi đăng ký:', e);
        } finally {
          resetBtn(signupBtn,'Đăng Ký');
        }
      };
    });
  </script>
</body>
</html>
