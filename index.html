<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tìm & Thay</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    [contenteditable]:empty:before { content: attr(placeholder); color: #aaa; }
    .hl { @apply bg-yellow-200; }
    .hl2 { @apply bg-pink-200; }
    .hl3 { @apply bg-blue-200; }
    .tag { @apply inline-block bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs mr-1 mb-1; }
    .tag span { @apply cursor-pointer ml-1 font-bold; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col p-2 text-xs">

  <!-- 3 CỘT CHÍNH -->
  <div class="flex flex-1 gap-2 overflow-hidden">

    <!-- CỘT 1: TÌM KIẾM -->
    <div class="w-64 bg-white p-3 rounded shadow space-y-2 flex flex-col">
      <h3 class="font-bold">Tìm kiếm</h3>
      <input id="kwInput" placeholder="Nhập từ, bấm Enter..." class="w-full p-1.5 border rounded">
      <div class="flex gap-1">
        <button id="searchBtn" class="flex-1 bg-green-500 text-white py-1 rounded">Tìm</button>
        <button id="clearBtn" class="flex-1 bg-red-500 text-white py-1 rounded">Xóa</button>
      </div>
      <div id="tags" class="flex flex-wrap flex-1 overflow-y-auto"></div>
    </div>

    <!-- CỘT 2: NỘI DUNG -->
    <div class="flex-1 bg-white p-4 rounded shadow flex flex-col">
      <h3 class="font-bold mb-2">Nội dung</h3>
      <div id="content" contenteditable placeholder="Dán văn bản..." 
           class="flex-1 p-3 border rounded overflow-y-auto whitespace-pre-wrap" 
           style="min-height:0; line-height:1.6;"></div>
    </div>

    <!-- CỘT 3: THAY THẾ -->
    <div class="w-64 bg-white p-3 rounded shadow space-y-2 flex flex-col">
      <h3 class="font-bold">Thay thế</h3>
      <div id="pairs" class="space-y-1 flex-1 overflow-y-auto"></div>
      <div class="flex gap-1">
        <button id="addPairBtn" class="flex-1 bg-blue-500 text-white py-1 rounded text-xs">+ Cặp</button>
        <button id="replaceAllBtn" class="flex-1 bg-purple-600 text-white py-1 rounded text-xs">Thay</button>
      </div>
    </div>

  </div>

  <!-- JS SIÊU GỌN, ĐỒNG BỘ 100% -->
  <script>
    // === DOM – ĐÚNG ID TRONG HTML ===
    const kwInput = document.getElementById('kwInput');
    const tags = document.getElementById('tags');
    const content = document.getElementById('content');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const pairs = document.getElementById('pairs');
    const addPairBtn = document.getElementById('addPairBtn');
    const replaceAllBtn = document.getElementById('replaceAllBtn');

    // === STATE ===
    let keywords = [];
    let lastReplaced = [];
    const classes = ['hl', 'hl2', 'hl3'];

    // === ENTER: THÊM TỪ KHÓA NGAY ===
    kwInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const v = kwInput.value.trim();
        if (v && !keywords.includes(v)) {
          keywords.push(v);
          addTag(v);
          highlight();
        }
        kwInput.value = '';
      }
    });

    // === THÊM TAG ===
    function addTag(word) {
      const tag = document.createElement('div');
      tag.className = 'tag';
      tag.innerHTML = `${word} <span>x</span>`;
      tag.querySelector('span').onclick = () => {
        keywords = keywords.filter(k => k !== word);
        tag.remove();
        highlight();
      };
      tags.appendChild(tag);
    }

    // === HIGHLIGHT SIÊU NHANH ===
    function highlight() {
      // Xóa highlight cũ
      content.innerHTML = content.textContent;

      // Tạo bản sao text để tìm
      let text = content.textContent;
      let html = content.innerHTML;
      let offset = 0;

      // Duyệt từ khóa + từ đã thay
      [...keywords, ...lastReplaced].forEach((word, i) => {
        if (!word) return;
        const regex = new RegExp(`\\b${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
        text.replace(regex, (match, pos) => {
          const start = pos;
          const end = start + match.length;
          const span = `<span class="${classes[i % 3]}">${match}</span>`;
          html = html.slice(0, start + offset) + span + html.slice(end + offset);
          offset += span.length - match.length;
        });
      });

      content.innerHTML = html;
    }

    // === THÊM CẶP TÌM-THAY (NÚT × RÕ RÀNG) ===
    function addPairRow(find = '', replace = '') {
      const row = document.createElement('div');
      row.className = 'flex gap-1 items-center';
      row.innerHTML = `
        <input class="find flex-1 p-1 border rounded text-xs" value="${find}" placeholder="Tìm...">
        <input class="replace flex-1 p-1 border rounded text-xs" value="${replace}" placeholder="Thay...">
        <button class="w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold hover:bg-red-600">×</button>
      `;
      row.querySelector('button').onclick = () => {
        row.remove();
        if (!pairs.children.length) addPairRow();
      };
      pairs.appendChild(row);
    }

    // === THAY THẾ ===
    replaceAllBtn.onclick = () => {
      const list = Array.from(pairs.querySelectorAll('div')).map(r => ({
        find: r.querySelector('.find').value.trim(),
        replace: r.querySelector('.replace').value
      })).filter(p => p.find);

      if (!list.length) return alert('Chưa có cặp!');
      
      let text = content.textContent;
      let changed = false;

      list.forEach(p => {
        const regex = new RegExp(`\\b${p.find.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
        if (regex.test(text)) {
          text = text.replace(regex, p.replace);
          changed = true;
        }
      });

      if (!changed) return alert('Không tìm thấy!');

      content.textContent = text;
      lastReplaced = list.map(p => p.replace).filter(Boolean);
      highlight();
    };

    // === NÚT TÌM / XÓA ===
    searchBtn.onclick = highlight;
    clearBtn.onclick = () => {
      keywords = [];
      tags.innerHTML = '';
      highlight();
    };

    // === NÚT THÊM CẶP ===
    addPairBtn.onclick = () => addPairRow();

    // === PASTE MƯỢT ===
    content.addEventListener('paste', e => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text');
      document.execCommand('insertText', false, text);
      highlight();
    });

    // === INPUT: TỰ ĐỘNG HIGHLIGHT ===
    content.addEventListener('input', highlight);

    // === KHỞI TẠO ===
    addPairRow(); // 1 cặp mặc định
  </script>
</body>
</html>
